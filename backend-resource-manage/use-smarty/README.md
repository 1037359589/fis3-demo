## 用 Smarty 模板

Smarty 模板也是 PHP 写的，但好处是提供了若干插件，当真正和后端分离是不需要有后端支持就能用插件的方式解决静态资源管理这个事情；


### 历史回顾

- FIS 2.0 时期支持 Smarty 开发的成套解决方案是 [fis-plus](/fex-team/fis-plus)
- FIS 3.0 时期支持 Smarty 开发的成套解决方案名字还没想好

### 需要做的事情

- 支持 Smarty 组件拆分
- 组件加载时作为入口，将模板依赖的资源全部加载
- 实现模板、js、css互相都可以依赖的模块化方案
    
    其实 FIS 一直提倡的是这种依赖模型，模板我可以依赖某些 js，css 组件，js 依赖一些 css 组件，甚至 css 去依赖 js 组件；

    其实说白了就是一个入口的问题，入口文件依赖别的什么文件；

    浏览器解析网页，模板是第一入口，后由于一些逻辑要执行 js 成为另一个入口，附带一些内嵌模板以及 css 的依赖。

    现在市面上的除了 web components 以外，都是js模块化管理方案，其实并没有给一种能力去让模板依赖资源，而是引入资源。FIS 就实现了各个资源之间互相依赖的特性，在本地编译期间就产出其依赖树，方便线上运行加载。

### 怎么做

上面说到过，模板依赖某个组件（模板，js，css）不再直接引入，而是添加依赖，这些依赖在 FIS 本地编译的时候会产出依赖树，我们一直都叫它**静态资源映射表**；

举个例子；

我给资源都标注一些依赖；比如我模板是这么写的；

*index.tpl*
```smarty
<!-- @require /static/a.js -->
<!-- @require /static/b.js -->
```

> 这块的 `require` 并没有 js 模块化框架里面的 `require` 的功效，其只是标明这个模板依赖俩 js 文件。<br />
> 当然，有的时候需要把 js 模块化也算进去，也经常会根据 js 里面的 `require` 信息去标明依赖，其实这个导致的后果是以为 FIS 本身依赖了某种 js组件化 加载规范，其实 FIS 是裸规范的，所以不管是 AMD、commonJs亦或是你自己实现的*MD，都是可以通过插件去运作起来的。 

当编译的时候，会在最终产出的数据结构中包含这样一个信息

```js
{
    "res": {
        "static/a.js": {
            "uri": "/static/a.js",
            "type": "js"
        },
        "static/b.js": {
            "uri": "/static/b.js",
            "type": "js"
        },
        "index.tpl": {
            "uri": "/index.tpl",
            "type": "tpl",
            "deps": [
                "static/a.js",
                "static/b.js"
            ]
        }
    }
}
```

    你可以在任意的一个文件中包含


    __RESOURCE_MAP__


    字样，产出时这个结构就会替换 __RESOURCE_MAP__。

**等等，标记了依赖我们的资源如何加载？**

一般的模板开发都是 js，css 都是 script，link 到页面的，或者是直接用 `require.js` 之类的进行异步加载，最终也是给页面建 script 节点做的加载。

那么我们这种方式如何加载呢，上面我们得到了模板依赖树的一张表；我们可以通过**前端**解析这张表去加载资源也可以**后端**解析这张表加载资源；

这块我们选择**后端**解析这张表去做加载；
